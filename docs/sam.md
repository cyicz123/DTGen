# 文档: `sam.py`

此脚本是一个利用 Segment Anything Model (SAM) 对餐具图像进行交互式分割的工具。

## 功能概述

该工具的核心功能是允许用户通过在图像上绘制边界框（bounding box）来精确地分割出餐具区域。分割后的餐具会以透明背景的 PNG 图片形式保存。

主要特点：

*   **交互式分割**：通过一个 GUI 窗口，用户可以方便地用鼠标框选目标区域。
*   **SAM 模型驱动**：利用强大的 SAM 模型进行高精度的图像分割。
*   **两种操作模式**：
    1.  **命令行模式**：快速处理一个或多个指定的图像文件。
    2.  **交互式批量模式**：专门用于处理预设目录结构的数据集，方便批量操作。
*   **智能过滤**：可以设置一个最小面积比例阈值，自动过滤掉过小的、可能是噪声的分割结果。
*   **掩码优化**：对生成的分割掩码（mask）进行空洞填充，确保分割区域的完整性。

## 先决条件

在运行此脚本之前，你需要下载 SAM 预训练模型权重。

*   下载模型权重文件 `sam_vit_h_4b8939.pth`。
*   在项目根目录下创建一个 `models` 文件夹。
*   将下载的模型文件放入 `models` 文件夹中。

最终路径应为：`models/sam_vit_h_4b8939.pth`。

## 使用方法

### 模式一：命令行模式

这种模式用于处理任意位置的单个或多个图像。

**基本用法：**

```bash
# 处理单个图片，结果将保存在默认的 `output/` 目录中
python scripts/sam.py /path/to/your/image.jpg

# 处理多个图片
python scripts/sam.py image1.jpg image2.png image3.jpeg
```

**指定输出目录：**

使用 `-o` 或 `--output` 参数。

```bash
python scripts/sam.py image.jpg -o my_segmented_images/
```

**设置面积过滤阈值：**

使用 `-m` 或 `--min-area-ratio` 参数。该值表示分割区域占总图像面积的最小比例，小于此比例的分割结果将被丢弃。

```bash
# 只保留面积占比超过 5% 的分割结果
python scripts/sam.py image.jpg -m 0.05
```

### 模式二：交互式批量模式

这种模式专为处理具有特定目录结构的数据集而设计。它会让你选择处理 `datasets/train/cleaned` 或 `datasets/train/dirty` 目录，并将结果分别保存到 `datasets/plate/cleaned` 和 `datasets/plate/dirty`。

**启动交互模式：**

```bash
python scripts/sam.py -i
# 或者
python scripts/sam.py --interactive
```

启动后，程序会提示你选择要处理的目录（干净餐具、脏污餐具或两者都处理）。

## GUI 操作指南

无论在哪种模式下，处理每张图片时都会弹出一个窗口：

*   **框选区域**：按住鼠标左键并拖动，在餐具周围绘制一个矩形框。
*   **确认选择**：绘制完成后，松开鼠标，然后按 `空格键` 确认选择并开始分割。
*   **重置选择**：如果对框选不满意，可以按 `r` 键清除选择，重新绘制。
*   **跳过图片**：按 `q` 键可以跳过当前图片，不进行处理。

## 命令行参数

*   `images`: **[命令行模式]** 一个或多个输入图片的文件路径（位置参数）。
*   `-o`, `--output`: **[命令行模式]** 输出目录的路径。默认为 `output`。
*   `-m`, `--min-area-ratio`: 分割掩码的最小面积比例阈值。默认为 `0.01`。
*   `-i`, `--interactive`: 启用交互式批量模式，用于处理预设的数据集目录。
